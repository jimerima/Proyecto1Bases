{% extends "base.html" %}

{% block titulo %}Consultar lecturas por una persona{% endblock %}

{% block contenido %}
  <div class="hero" style="text-align:center; padding-top: 2rem;">
    <div class="col" style="margin:auto; max-width:920px; text-align:left;">
      <div class="eyebrow">Consultas</div>
      <h1>Consultar lecturas por una persona</h1>
      <p class="lead" style="font-size:1.05rem; margin-bottom:1.25rem; color:#fff;">
        Selecciona a la persona a consultar</p>

      <form action="{{ url_for('vista_consultar_lecturas') }}" method="post" style="margin-top:1rem;">
        <div class="form-control" style="margin-bottom:1.25rem;">
          <!-- Dropdown first -->
          <select id="persona_select" name="persona_select"
                  style="width:100%; padding:.6rem; font-size:1rem; border-radius:8px; border:1px solid #ccc; margin-bottom:.6rem;">
            <option value="">‚Äî Seleccionar persona ‚Äî</option>
            {% if personas.items is defined %}
              {% for id, p in personas.items() %}
                <option value="{{ id }}" data-name="{{ p.nombre }}">{{ p.nombre }}</option>
              {% endfor %}
            {% else %}
              {% for p in personas %}
                <option value="{{ p.id }}" data-name="{{ p.nombre }}">{{ p.nombre }}</option>
              {% endfor %}
            {% endif %}
          </select>

          <!-- Separator "O" -->
          <div style="text-align:center; margin:0.6rem 0; color:#fff; font-weight:600;">O</div>

          <!-- Free-text input with its own label -->
          <label for="persona_nombre" style="font-weight:600; margin-bottom:.5rem; display:block; color:#fff;">
            Escriba el nombre de la persona a consultar
          </label>
          <input type="text" name="persona_nombre" id="persona_nombre" list="sugerencias_personas"
                 placeholder="Ej.: Ana Rojas"
                 style="width:100%; padding:.8rem; font-size:1rem; border-radius:8px; border:1px solid #ccc;">
          <input type="hidden" name="persona_id" id="persona_id">

          <datalist id="sugerencias_personas">
            {% if personas.items is defined %}
              {% for id, p in personas.items() %}
                <option value="{{ p.nombre }}" data-id="{{ id }}">{{ id }} ‚Äî {{ p.nombre }}</option>
              {% endfor %}
            {% else %}
              {% for p in personas %}
                <option value="{{ p.nombre }}" data-id="{{ p.id }}">{{ p.id }} ‚Äî {{ p.nombre }}</option>
              {% endfor %}
            {% endif %}
          </datalist>

          <small style="display:block; margin-top:.4rem; color:#fff;">
            Si escribes el nombre, se ignorar√° la selecci√≥n del listado.
          </small>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('persona_nombre');
            const hidden = document.getElementById('persona_id');
            const datalist = document.getElementById('sugerencias_personas');
            const select = document.getElementById('persona_select');

            // When the select changes, populate the text input and hidden id
            select.addEventListener('change', function() {
              const opt = select.options[select.selectedIndex];
              if (select.value) {
                const name = opt.getAttribute('data-name') || opt.text;
                input.value = name;
                hidden.value = select.value;
              } else {
                input.value = '';
                hidden.value = '';
              }
            });

            // When typing in the text input, try to match a datalist option.
            // If matched, set hidden id and sync select. If not, clear hidden and select.
            input.addEventListener('input', function() {
              let found = false;
              for (const option of datalist.options) {
                if (option.value === input.value) {
                  const id = option.getAttribute('data-id') || '';
                  hidden.value = id;
                  // try to set select to the matching id
                  if (id) {
                    let matched = false;
                    for (const sopt of select.options) {
                      if (sopt.value === id) {
                        select.value = id;
                        matched = true;
                        break;
                      }
                    }
                    if (!matched) select.value = '';
                  } else {
                    select.value = '';
                  }
                  found = true;
                  break;
                }
              }
              if (!found) {
                hidden.value = '';
                select.value = '';
              }
            });
          });
        </script>

        <div class="actions" style="display:flex; justify-content:flex-end; gap:.8rem; margin-top:1.1rem;">
          <a class="btn btn--secondary" href="{{ url_for('vista_consultas') }}"
             style="text-decoration:none; background:#e0e0e0; color:#000;">‚¨Ö Volver</a>
          <button class="btn btn--primary" type="submit"
                  style="padding:.8rem 1.6rem; font-size:1rem; border-radius:10px;">üîç Consultar</button>
        </div>
      </form>

      {% if libros is defined %}
        <div class="divider" style="margin:1.4rem 0;"></div>
        <h2 style="color:#fff;">Resultados</h2>
        

        {% if libros %}
          <div style="overflow:auto; border:1px solid #ddd; border-radius:10px; background:#fff;">
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:.7rem; border-bottom:1px solid #eee;">T√≠tulo</th>
                  <th style="text-align:left; padding:.7rem; border-bottom:1px solid #eee;">G√©nero</th>
                  <th style="text-align:left; padding:.7rem; border-bottom:1px solid #eee;">A√±o</th>
                </tr>
              </thead>
              <tbody>
                {% for libro in libros %}
                  <tr>
                    <td style="padding:.65rem; border-bottom:1px solid #f3f3f3;">
                      {{ libro.titulo or libro.Titulo }}
                    </td>
                    <td style="padding:.65rem; border-bottom:1px solid #f3f3f3;">
                      {{ libro.genero or libro.Genero }}
                    </td>
                    <td style="padding:.65rem; border-bottom:1px solid #f3f3f3;">
                      {{ libro.anno or libro.Anno }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p style="margin-top:.75rem; color:#fff;">No se encontraron lecturas para esa persona.</p>
        {% endif %}
      {% endif %}
    </div>
  </div>
{% endblock %}
